<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Templates - Community Help Platform</title>
    <link href="../css/main.css" rel="stylesheet">
</head>
<body class="bg-surface min-h-screen">
    <!-- Navigation Header -->
    <header class="bg-white border-b border-border sticky top-0 z-50 shadow-subtle">
        <nav class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <a href="citizen_dashboard.html" class="flex items-center gap-3">
                        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#3B82F6" opacity="0.1" />
                            <path d="M20 8C13.373 8 8 13.373 8 20C8 26.627 13.373 32 20 32C26.627 32 32 26.627 32 20C32 13.373 26.627 8 20 8ZM20 14C21.657 14 23 15.343 23 17C23 18.657 21.657 20 20 20C18.343 20 17 18.657 17 17C17 15.343 18.343 14 20 14ZM20 29C17.333 29 14.982 27.667 13.5 25.667C13.533 23.622 17.5 22.5 20 22.5C22.5 22.5 26.467 23.622 26.5 25.667C25.018 27.667 22.667 29 20 29Z" fill="#3B82F6" />
                        </svg>
                        <span class="text-xl font-semibold text-text-primary">Community Help</span>
                    </a>
                </div>
                <a href="citizen_dashboard.html" class="text-text-secondary hover:text-primary transition-micro">
                    ‚Üê Back to Dashboard
                </a>
            </div>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <div class="card-elevated mb-6">
                <h1 class="text-2xl font-bold text-text-primary mb-4">Request Templates</h1>
                <p class="text-text-secondary mb-6">Choose from pre-built templates to quickly create your help request</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="templatesGrid">
                    <!-- Templates will be loaded here -->
                </div>
            </div>

            <!-- Custom Template Creation -->
            <div class="card-elevated">
                <h2 class="text-xl font-bold text-text-primary mb-4">Create Custom Template</h2>
                <form id="customTemplateForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Template Name</label>
                            <input type="text" id="templateTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <select id="templateCategory" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select category</option>
                                <option value="shopping">Shopping</option>
                                <option value="transportation">Transportation</option>
                                <option value="technology">Technology</option>
                                <option value="household">Household</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="emergency">Emergency</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description Template</label>
                        <textarea id="templateDescription" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Describe what help is needed..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Urgency</label>
                            <select id="templateUrgency" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Time</label>
                            <input type="text" id="templateTime" placeholder="e.g., 1-2 hours" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary">
                        Create Template
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { templateService } from '../js/enhanced-features.js';
        import { auth } from '../js/firebase-config.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = user;
            loadTemplates();
        });

        function loadTemplates() {
            try {
                // Load default templates
                const defaultTemplates = templateService.getDefaultTemplates();
                
                // Load custom templates from localStorage
                const customTemplates = JSON.parse(localStorage.getItem('customTemplates') || '[]');
                
                const allTemplates = [...defaultTemplates, ...customTemplates];
                displayTemplates(allTemplates);
            } catch (error) {
                console.error('Error loading templates:', error);
                displayTemplates(templateService.getDefaultTemplates());
            }
        }

        function displayTemplates(templates) {
            const grid = document.getElementById('templatesGrid');
            grid.innerHTML = '';

            templates.forEach(template => {
                const templateCard = document.createElement('div');
                const isCustom = template.isCustom;
                templateCard.className = 'card border border-border hover:shadow-md transition-standard';
                templateCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-text-primary">${template.title}</h3>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs rounded-full ${getUrgencyColor(template.urgency)}">${template.urgency}</span>
                            ${isCustom ? '<span class="px-2 py-1 text-xs bg-accent-50 text-accent-700 rounded-full">Custom</span>' : ''}
                        </div>
                    </div>
                    <p class="text-sm text-text-secondary mb-3">${template.description}</p>
                    <div class="flex justify-between items-center text-xs text-text-secondary mb-3">
                        <span class="bg-surface px-2 py-1 rounded capitalize">${template.category.replace('_', ' ')}</span>
                        ${template.estimatedTime ? `<span class="font-medium">${template.estimatedTime}</span>` : ''}
                    </div>
                    <div class="flex items-center justify-between pt-2 border-t border-border">
                        <button onclick="useTemplate('${template.id}')" class="btn-primary text-xs px-3 py-1">
                            Use Template
                        </button>
                        <div class="flex items-center gap-2">
                            <button onclick="viewTemplate('${template.id}')" class="text-xs text-primary hover:text-primary-600 px-2 py-1">
                                View
                            </button>
                            ${isCustom ? `
                                <button onclick="editTemplate('${template.id}')" class="text-xs text-warning-600 hover:text-warning-700 px-2 py-1">
                                    Edit
                                </button>
                                <button onclick="deleteTemplate('${template.id}')" class="text-xs text-error hover:text-error-600 px-2 py-1">
                                    Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                grid.appendChild(templateCard);
            });
        }

        function getUrgencyColor(urgency) {
            switch(urgency) {
                case 'high': return 'bg-error-100 text-error-700';
                case 'medium': return 'bg-warning-100 text-warning-700';
                case 'low': return 'bg-success-100 text-success-700';
                default: return 'bg-secondary-100 text-text-secondary';
            }
        }

        window.useTemplate = function(templateId) {
            const defaultTemplates = templateService.getDefaultTemplates();
            const customTemplates = JSON.parse(localStorage.getItem('customTemplates') || '[]');
            const allTemplates = [...defaultTemplates, ...customTemplates];
            const template = allTemplates.find(t => t.id === templateId);
            
            if (!template) return;
            
            // Redirect to create request page with template data
            const params = new URLSearchParams({
                template: 'true',
                title: template.title,
                category: template.category,
                description: template.description,
                urgency: template.urgency
            });
            window.location.href = `create_request.html?${params.toString()}`;
        }
        
        // View template function
        window.viewTemplate = function(templateId) {
            const defaultTemplates = templateService.getDefaultTemplates();
            const customTemplates = JSON.parse(localStorage.getItem('customTemplates') || '[]');
            const allTemplates = [...defaultTemplates, ...customTemplates];
            const template = allTemplates.find(t => t.id === templateId);
            
            if (!template) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="card-modal max-w-2xl w-full">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-text-primary">${template.title}</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-text-secondary hover:text-text-primary">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-primary mb-1">Category</label>
                                <span class="bg-surface px-3 py-2 rounded-md text-sm capitalize">${template.category.replace('_', ' ')}</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-primary mb-1">Urgency</label>
                                <span class="px-2 py-1 text-xs rounded-full ${getUrgencyColor(template.urgency)}">${template.urgency}</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Description</label>
                            <div class="bg-surface p-4 rounded-lg">
                                <p class="text-text-secondary">${template.description}</p>
                            </div>
                        </div>
                        ${template.estimatedTime ? `
                            <div>
                                <label class="block text-sm font-medium text-text-primary mb-1">Estimated Time</label>
                                <span class="text-text-secondary">${template.estimatedTime}</span>
                            </div>
                        ` : ''}
                        <div class="flex gap-3 pt-4">
                            <button onclick="useTemplate('${template.id}'); this.closest('.fixed').remove();" class="btn-primary flex-1">
                                Use This Template
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="btn-outline">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };
        
        // Edit template function
        window.editTemplate = function(templateId) {
            const customTemplates = JSON.parse(localStorage.getItem('customTemplates') || '[]');
            const template = customTemplates.find(t => t.id === templateId);
            
            if (!template) return;
            
            // Pre-fill the form with existing data
            document.getElementById('templateTitle').value = template.title;
            document.getElementById('templateCategory').value = template.category;
            document.getElementById('templateDescription').value = template.description;
            document.getElementById('templateUrgency').value = template.urgency;
            document.getElementById('templateTime').value = template.estimatedTime || '';
            
            // Change form behavior to edit mode
            const form = document.getElementById('customTemplateForm');
            form.dataset.editId = templateId;
            document.querySelector('.card-elevated h2').textContent = 'Edit Custom Template';
            document.querySelector('#customTemplateForm button[type="submit"]').textContent = 'Update Template';
            
            // Scroll to form
            document.querySelector('.card-elevated:last-child').scrollIntoView({ behavior: 'smooth' });
        };
        
        // Delete template function
        window.deleteTemplate = function(templateId) {
            if (!confirm('Are you sure you want to delete this template?')) return;
            
            const customTemplates = JSON.parse(localStorage.getItem('customTemplates') || '[]');
            const updatedTemplates = customTemplates.filter(t => t.id !== templateId);
            localStorage.setItem('customTemplates', JSON.stringify(updatedTemplates));
            
            loadTemplates();
        };

        document.getElementById('customTemplateForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const form = e.target;
            const editId = form.dataset.editId;
            const isEditing = !!editId;
            
            const templateData = {
                id: editId || 'custom_' + Date.now(),
                title: document.getElementById('templateTitle').value,
                category: document.getElementById('templateCategory').value,
                description: document.getElementById('templateDescription').value,
                urgency: document.getElementById('templateUrgency').value,
                estimatedTime: document.getElementById('templateTime').value,
                isCustom: true
            };

            try {
                const existingTemplates = JSON.parse(localStorage.getItem('customTemplates') || '[]');
                
                if (isEditing) {
                    // Update existing template
                    const index = existingTemplates.findIndex(t => t.id === editId);
                    if (index !== -1) {
                        existingTemplates[index] = templateData;
                    }
                    alert('Template updated successfully!');
                    
                    // Reset form to create mode
                    delete form.dataset.editId;
                    document.querySelector('.card-elevated h2').textContent = 'Create Custom Template';
                    document.querySelector('#customTemplateForm button[type="submit"]').textContent = 'Create Template';
                } else {
                    // Create new template
                    existingTemplates.push(templateData);
                    alert('Template created successfully!');
                }
                
                localStorage.setItem('customTemplates', JSON.stringify(existingTemplates));
                document.getElementById('customTemplateForm').reset();
                loadTemplates();
            } catch (error) {
                console.error('Error saving template:', error);
                alert('Error saving template. Please try again.');
            }
        });
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>