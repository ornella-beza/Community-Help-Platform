<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Board - Community Help Platform</title>
    <link href="../css/main.css" rel="stylesheet">
</head>
<body class="bg-surface min-h-screen">
    <!-- Navigation Header -->
    <header class="bg-white border-b border-border sticky top-0 z-50 shadow-subtle">
        <nav class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <a href="citizen_dashboard.html" class="flex items-center gap-3">
                        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#3B82F6" opacity="0.1" />
                            <path d="M20 8C13.373 8 8 13.373 8 20C8 26.627 13.373 32 20 32C26.627 32 32 26.627 32 20C32 13.373 26.627 8 20 8ZM20 14C21.657 14 23 15.343 23 17C23 18.657 21.657 20 20 20C18.343 20 17 18.657 17 17C17 15.343 18.343 14 20 14ZM20 29C17.333 29 14.982 27.667 13.5 25.667C13.533 23.622 17.5 22.5 20 22.5C22.5 22.5 26.467 23.622 26.5 25.667C25.018 27.667 22.667 29 20 29Z" fill="#3B82F6" />
                        </svg>
                        <span class="text-xl font-semibold text-text-primary">Community Help</span>
                    </a>
                </div>
                <a href="citizen_dashboard.html" class="text-text-secondary hover:text-primary transition-micro">
                    ‚Üê Back to Dashboard
                </a>
            </div>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="card-elevated mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold text-text-primary">Community Board</h1>
                    <button id="createPostBtn" class="btn-primary">
                        Create Post
                    </button>
                </div>
                
                <!-- Tabs -->
                <div class="grid grid-cols-3 gap-2 bg-surface p-1 rounded-lg">
                    <button class="tab-btn active px-4 py-2 rounded-md bg-white text-primary font-medium shadow-sm" data-tab="announcements">
                        üì¢ Announcements
                    </button>
                    <button class="tab-btn px-4 py-2 rounded-md text-text-secondary hover:bg-white hover:text-primary transition-micro" data-tab="success-stories">
                        üéâ Success Stories
                    </button>
                    <button class="tab-btn px-4 py-2 rounded-md text-text-secondary hover:bg-white hover:text-primary transition-micro" data-tab="recognition">
                        ‚≠ê Recognition
                    </button>
                </div>
            </div>

            <!-- Create Post Modal -->
            <div id="createPostModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="card-modal w-full max-w-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-text-primary">Create Post</h2>
                            <button id="closeModal" class="text-text-secondary hover:text-text-primary">&times;</button>
                        </div>
                        
                        <form id="createPostForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Post Type</label>
                                <select id="postType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="announcement">Announcement</option>
                                    <option value="success-story">Success Story</option>
                                    <option value="recognition">Volunteer Recognition</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                <input type="text" id="postTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Content</label>
                                <textarea id="postContent" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            
                            <div id="recognitionFields" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Volunteer Email (for recognition)</label>
                                <input type="email" id="volunteerEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button type="button" id="cancelPost" class="btn-outline">Cancel</button>
                                <button type="submit" class="btn-primary">Post</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Posts Container -->
            <div id="postsContainer">
                <!-- Posts will be loaded here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { communityService } from '../js/enhanced-features.js';
        import { auth, db } from '../js/firebase-config.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        let currentUser = null;
        let currentTab = 'announcements';

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = user;
            loadPosts();
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active', 'bg-white', 'text-primary', 'shadow-sm');
                    b.classList.add('text-text-secondary');
                });
                btn.classList.add('active', 'bg-white', 'text-primary', 'shadow-sm');
                btn.classList.remove('text-text-secondary');
                
                currentTab = btn.dataset.tab;
                loadPosts();
            });
        });

        // Modal controls
        document.getElementById('createPostBtn').addEventListener('click', () => {
            document.getElementById('createPostModal').classList.remove('hidden');
        });

        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('cancelPost').addEventListener('click', closeModal);

        function closeModal() {
            document.getElementById('createPostModal').classList.add('hidden');
            document.getElementById('createPostForm').reset();
            document.getElementById('recognitionFields').classList.add('hidden');
            
            // Reset form to create mode
            const form = document.getElementById('createPostForm');
            delete form.dataset.editId;
            document.querySelector('#createPostModal h2').textContent = 'Create Post';
            document.querySelector('#createPostModal button[type="submit"]').textContent = 'Post';
        }

        // Show/hide recognition fields
        document.getElementById('postType').addEventListener('change', (e) => {
            const recognitionFields = document.getElementById('recognitionFields');
            if (e.target.value === 'recognition') {
                recognitionFields.classList.remove('hidden');
            } else {
                recognitionFields.classList.add('hidden');
            }
        });

        // Create/Edit post form
        document.getElementById('createPostForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const form = e.target;
            const editId = form.dataset.editId;
            const isEditing = !!editId;
            
            const postData = {
                id: editId || 'post_' + Date.now(),
                type: document.getElementById('postType').value,
                title: document.getElementById('postTitle').value,
                content: document.getElementById('postContent').value,
                volunteerEmail: document.getElementById('volunteerEmail').value || null,
                authorId: currentUser?.uid || 'anonymous',
                createdAt: isEditing ? undefined : new Date()
            };

            try {
                const existingPosts = JSON.parse(localStorage.getItem('communityPosts') || '[]');
                
                if (isEditing) {
                    // Update existing post
                    const index = existingPosts.findIndex(p => p.id === editId);
                    if (index !== -1) {
                        existingPosts[index] = { ...existingPosts[index], ...postData };
                    }
                    alert('Post updated successfully!');
                } else {
                    // Create new post
                    existingPosts.unshift(postData);
                    alert('Post created successfully!');
                }
                
                localStorage.setItem('communityPosts', JSON.stringify(existingPosts));
                closeModal();
                loadPosts();
            } catch (error) {
                console.error('Error saving post:', error);
                alert('Error saving post. Please try again.');
            }
        });

        function loadPosts() {
            try {
                // Load from localStorage
                const allPosts = JSON.parse(localStorage.getItem('communityPosts') || '[]');
                
                // Add some default posts if none exist
                if (allPosts.length === 0) {
                    const defaultPosts = [
                        {
                            id: 'default_1',
                            type: 'announcement',
                            title: 'Welcome to Community Help Platform!',
                            content: 'We\'re excited to have you join our community. Together, we can make a difference in our neighborhoods.',
                            authorId: 'admin',
                            createdAt: new Date(Date.now() - 86400000) // 1 day ago
                        },
                        {
                            id: 'default_2',
                            type: 'success-story',
                            title: 'Successful Grocery Delivery',
                            content: 'Thanks to our amazing volunteer John, Mrs. Smith received her weekly groceries safely. Community helping community!',
                            authorId: 'admin',
                            createdAt: new Date(Date.now() - 172800000) // 2 days ago
                        }
                    ];
                    localStorage.setItem('communityPosts', JSON.stringify(defaultPosts));
                    displayPosts(defaultPosts);
                    return;
                }
                
                // Filter posts by current tab
                let posts = allPosts.filter(post => {
                    if (currentTab === 'announcements') {
                        return post.type === 'announcement' || !post.type;
                    } else if (currentTab === 'success-stories') {
                        return post.type === 'success-story';
                    } else if (currentTab === 'recognition') {
                        return post.type === 'recognition';
                    }
                    return true;
                });
                
                displayPosts(posts);
            } catch (error) {
                console.error('Error loading posts:', error);
                document.getElementById('postsContainer').innerHTML = `
                    <div class="card-elevated text-center">
                        <p class="text-text-secondary">Error loading posts. Please try again later.</p>
                    </div>
                `;
            }
        }

        function displayPosts(posts) {
            const container = document.getElementById('postsContainer');
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="card-elevated text-center">
                        <p class="text-text-secondary">No posts yet. Be the first to share something!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            
            posts.forEach(post => {
                const authorData = { fullName: post.authorId === 'admin' ? 'Community Admin' : (currentUser?.fullName || 'Community Member') };
                const postElement = createPostElement(post, authorData);
                container.appendChild(postElement);
            });
        }

        function getUserData(userId) {
            if (userId === 'admin') {
                return { fullName: 'Community Admin' };
            }
            return { fullName: currentUser?.fullName || 'Community Member' };
        }

        function createPostElement(post, author) {
            const postDiv = document.createElement('div');
            postDiv.className = 'card-elevated mb-4';
            
            const typeIcon = getTypeIcon(post.type);
            const timeAgo = getTimeAgo(new Date(post.createdAt));
            
            const isOwner = post.authorId === (currentUser?.uid || 'anonymous');
            
            postDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white font-semibold text-lg">
                            ${author.fullName ? author.fullName.charAt(0).toUpperCase() : 'U'}
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="font-semibold text-text-primary">${author.fullName || 'Community Member'}</span>
                                <span class="text-text-secondary">‚Ä¢</span>
                                <span class="text-sm text-text-secondary">${timeAgo}</span>
                                ${typeIcon}
                            </div>
                            ${isOwner ? `
                                <div class="flex items-center space-x-2">
                                    <button onclick="viewPost('${post.id}')" class="text-xs text-primary hover:text-primary-600 px-2 py-1 rounded">
                                        View
                                    </button>
                                    <button onclick="editPost('${post.id}')" class="text-xs text-warning-600 hover:text-warning-700 px-2 py-1 rounded">
                                        Edit
                                    </button>
                                    <button onclick="deletePost('${post.id}')" class="text-xs text-error hover:text-error-600 px-2 py-1 rounded">
                                        Delete
                                    </button>
                                </div>
                            ` : `
                                <button onclick="viewPost('${post.id}')" class="text-xs text-primary hover:text-primary-600 px-2 py-1 rounded">
                                    View
                                </button>
                            `}
                        </div>
                        <h3 class="text-lg font-semibold text-text-primary mb-2">${post.title}</h3>
                        <p class="text-text-secondary whitespace-pre-wrap line-clamp-3">${post.content}</p>
                        ${post.volunteerEmail ? `<p class="text-sm text-primary mt-2 font-medium">üëè Recognizing: ${post.volunteerEmail}</p>` : ''}
                    </div>
                </div>
            `;
            
            return postDiv;
        }

        function getTypeIcon(type) {
            switch(type) {
                case 'announcement':
                    return '<span class="px-2 py-1 text-xs bg-primary-50 text-primary-700 rounded-full font-medium">üì¢</span>';
                case 'success-story':
                    return '<span class="px-2 py-1 text-xs bg-success-50 text-success-700 rounded-full font-medium">üéâ</span>';
                case 'recognition':
                    return '<span class="px-2 py-1 text-xs bg-warning-50 text-warning-700 rounded-full font-medium">‚≠ê</span>';
                default:
                    return '';
            }
        }
        
        // View post function
        window.viewPost = function(postId) {
            const posts = JSON.parse(localStorage.getItem('communityPosts') || '[]');
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="card-modal max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-text-primary">${post.title}</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-text-secondary hover:text-text-primary">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-2">
                            ${getTypeIcon(post.type)}
                            <span class="text-sm text-text-secondary">${getTimeAgo(new Date(post.createdAt))}</span>
                        </div>
                        <div class="bg-surface p-4 rounded-lg">
                            <p class="text-text-secondary whitespace-pre-wrap">${post.content}</p>
                        </div>
                        ${post.volunteerEmail ? `<p class="text-sm text-primary font-medium">üëè Recognizing: ${post.volunteerEmail}</p>` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };
        
        // Edit post function
        window.editPost = function(postId) {
            const posts = JSON.parse(localStorage.getItem('communityPosts') || '[]');
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            
            // Pre-fill the create post modal with existing data
            document.getElementById('postType').value = post.type;
            document.getElementById('postTitle').value = post.title;
            document.getElementById('postContent').value = post.content;
            if (post.volunteerEmail) {
                document.getElementById('volunteerEmail').value = post.volunteerEmail;
                document.getElementById('recognitionFields').classList.remove('hidden');
            }
            
            // Change form behavior to edit mode
            const form = document.getElementById('createPostForm');
            form.dataset.editId = postId;
            document.querySelector('#createPostModal h2').textContent = 'Edit Post';
            document.querySelector('#createPostModal button[type="submit"]').textContent = 'Update Post';
            
            document.getElementById('createPostModal').classList.remove('hidden');
        };
        
        // Delete post function
        window.deletePost = function(postId) {
            if (!confirm('Are you sure you want to delete this post?')) return;
            
            const posts = JSON.parse(localStorage.getItem('communityPosts') || '[]');
            const updatedPosts = posts.filter(p => p.id !== postId);
            localStorage.setItem('communityPosts', JSON.stringify(updatedPosts));
            
            loadPosts();
        };

        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Just now';
            
            const now = new Date();
            const postTime = new Date(timestamp);
            const diffMs = now - postTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>